// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum FunderType {
  PRIVATE_FOUNDATION
  COMMUNITY_FOUNDATION
  CORPORATE
  FEDERAL
  STATE
  LOCAL
  OTHER
}

enum OpportunitySource {
  FEDERAL_API
  USER_INGESTED
  FOUNDATION_990
}

enum DocumentType {
  PROPOSAL
  REPORT
  BUDGET
  LOI
  AWARD_LETTER
  AGREEMENT
  ANNUAL_REPORT
  STRATEGIC_PLAN
  EVALUATION
  OTHER
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  NEEDS_REVIEW
  FAILED
}

enum GrantStatus {
  PROSPECT
  RESEARCHING
  WRITING
  REVIEW
  SUBMITTED
  PENDING
  AWARDED
  DECLINED
  ACTIVE
  CLOSEOUT
  COMPLETED
}

enum CommitmentType {
  DELIVERABLE
  OUTCOME_METRIC
  REPORT_DUE
  BUDGET_SPEND
  STAFFING
  TIMELINE
}

enum CommitmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

enum ConflictType {
  METRIC_MISMATCH
  TIMELINE_OVERLAP
  BUDGET_DISCREPANCY
  CAPACITY_OVERCOMMIT
}

enum ConflictSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ConflictStatus {
  UNRESOLVED
  UNDER_REVIEW
  RESOLVED
  IGNORED
}

enum ComplianceActionType {
  CONFLICT_DETECTED
  CONFLICT_RESOLVED
  CONFLICT_IGNORED
  COMMITMENT_UPDATED
  SCAN_COMPLETED
  TEAM_MEMBER_INVITED
  TEAM_MEMBER_JOINED
  GRANT_ASSIGNED
  GRANT_UNASSIGNED
}

enum FunderRequirementType {
  INDIRECT_COST_CAP
  REPORTING_SCHEDULE
  BRANDING_REQUIREMENT
  FORMAT_REQUIREMENT
  MATCH_REQUIREMENT
  OTHER
}

enum NotificationType {
  DEADLINE_REMINDER
  WEEKLY_DIGEST
  COMPLIANCE_ALERT
  DOCUMENT_PROCESSED
  CONFLICT_DETECTED
  COMMITMENT_DUE
}

enum DigestFrequency {
  DAILY
  WEEKLY
  NONE
}

// ============================================================================
// MODELS
// ============================================================================

model Organization {
  id               String             @id @default(cuid())
  clerkOrgId       String?            @unique
  name             String
  ein              String?            @unique
  mission          String?            @db.Text
  voiceProfile     Json?
  voiceUpdatedAt   DateTime?

  // Onboarding fields
  onboardingCompleted Boolean         @default(false)
  onboardingStep      Int?            // Current step if incomplete (1-4)
  primaryProgramAreas String[]        // Array of program focus areas
  geographicArea      String?         // Service area description

  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  // Relations
  users            OrganizationUser[]
  programs         Program[]
  documents        Document[]
  grants           Grant[]
  commitments      Commitment[]
  fitScores        FitScore[]
  auditLogs        ComplianceAudit[]
  funderRequirements FunderRequirement[]
  invitations      TeamInvitation[]
  apiKeys          ApiKey[]
  webhooks         Webhook[]
}

model OrganizationUser {
  id             String       @id @default(cuid())
  organizationId String
  clerkUserId    String
  role           UserRole
  displayName    String?      // For @mentions and display
  avatarUrl      String?      // Cached from Clerk
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  notificationPreferences NotificationPreferences?
  notificationLogs        NotificationLog[]
  assignedGrants Grant[]      // Grants assigned to this user

  @@unique([organizationId, clerkUserId])
}

model Program {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  description    String?       @db.Text
  outcomes       Json?
  budget         Decimal?      @db.Decimal(15, 2)
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  grants         Grant[]
}

model Funder {
  id                  String         @id @default(cuid())
  name                String
  ein                 String?        @unique
  type                FunderType
  mission             String?        @db.Text
  city                String?
  state               String?
  nteeCode            String?
  programAreas        Json?          // Array of focus areas
  geographicFocus     Json?          // Geographic preferences
  totalAssets         Decimal?       @db.Decimal(15, 2)
  totalGiving         Decimal?       @db.Decimal(15, 2)
  grantSizeMin        Decimal?       @db.Decimal(15, 2)
  grantSizeMax        Decimal?       @db.Decimal(15, 2)
  grantSizeMedian     Decimal?       @db.Decimal(15, 2)
  website             String?
  applicationProcess  String?        @db.Text
  applicationDeadline String?        // e.g., "Quarterly: March 1, June 1, Sept 1, Dec 1"
  contactInfo         Json?          // { email, phone, address }
  historicalData      Json?          // 5-year giving trends
  lastSyncedAt        DateTime?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  // Relations
  opportunities       Opportunity[]
  pastGrantees        PastGrantee[]
  grants              Grant[]
  requirements        FunderRequirement[]
}

model PastGrantee {
  id            String   @id @default(cuid())
  funderId      String
  recipientName String
  recipientEin  String?
  amount        Decimal  @db.Decimal(15, 2)
  purpose       String?
  year          Int

  // Relations
  funder        Funder   @relation(fields: [funderId], references: [id], onDelete: Cascade)

  @@index([funderId])
}

model Opportunity {
  id           String              @id @default(cuid())
  funderId     String?
  title        String
  description  String?             @db.Text
  deadline     DateTime?
  amountMin    Decimal?            @db.Decimal(15, 2)
  amountMax    Decimal?            @db.Decimal(15, 2)
  source       OpportunitySource
  sourceUrl    String?
  requirements Json?
  eligibility  Json?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  // Relations
  funder       Funder?             @relation(fields: [funderId], references: [id], onDelete: SetNull)
  fitScores    FitScore[]
  grants       Grant[]

  @@index([deadline])
}

model FitScore {
  id               String       @id @default(cuid())
  opportunityId    String
  organizationId   String
  overallScore     Int
  missionScore     Int
  capacityScore    Int
  geographicScore  Int
  historyScore     Int
  reusableContent  Json?
  estimatedHours   Int?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  opportunity      Opportunity  @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, organizationId])
}

model Document {
  id               String           @id @default(cuid())
  organizationId   String
  grantId          String?
  name             String
  type             DocumentType
  mimeType         String
  size             Int
  s3Key            String
  status           ProcessingStatus @default(PENDING)
  confidenceScore  Int?
  parseWarnings    Json?
  extractedText    String?          @db.Text
  metadata         Json?
  pineconeIds      String[]
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  processedAt      DateTime?

  // Relations
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  grant            Grant?           @relation(fields: [grantId], references: [id], onDelete: SetNull)
  sourceCommitments Commitment[]

  @@index([organizationId])
  @@index([status])
}

model Grant {
  id              String       @id @default(cuid())
  organizationId  String
  funderId        String?
  opportunityId   String?
  programId       String?
  status          GrantStatus  @default(PROSPECT)
  amountRequested Decimal?     @db.Decimal(15, 2)
  amountAwarded   Decimal?     @db.Decimal(15, 2)
  deadline        DateTime?
  submittedAt     DateTime?
  awardedAt       DateTime?
  startDate       DateTime?
  endDate         DateTime?
  notes           String?      @db.Text
  assignedToId    String?      // Assigned team member
  assignedAt      DateTime?    // When assigned
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Draft content storage
  draftContent    Json?        // { [sectionName]: { content: string, wordCount: number, lastUpdated: DateTime } }
  aiAuditLog      Json?        // Array of { timestamp, action, sectionName, prompt, sources, confidence }

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  funder          Funder?      @relation(fields: [funderId], references: [id], onDelete: SetNull)
  opportunity     Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  program         Program?     @relation(fields: [programId], references: [id], onDelete: SetNull)
  assignedTo      OrganizationUser? @relation(fields: [assignedToId], references: [id], onDelete: SetNull)
  documents       Document[]
  commitments     Commitment[]

  @@index([organizationId])
  @@index([status])
  @@index([deadline])
  @@index([assignedToId])
}

model Commitment {
  id                 String             @id @default(cuid())
  organizationId     String
  grantId            String
  type               CommitmentType
  description        String
  metricName         String?
  metricValue        String?
  dueDate            DateTime?
  status             CommitmentStatus   @default(PENDING)
  sourceDocumentId   String?
  sourceText         String?            @db.Text
  extractedBy        String             @default("AI")
  confidence         Int?
  verifiedAt         DateTime?
  verifiedBy         String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Relations
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  grant              Grant              @relation(fields: [grantId], references: [id], onDelete: Cascade)
  sourceDocument     Document?          @relation(fields: [sourceDocumentId], references: [id], onDelete: SetNull)
  conflicts          CommitmentConflict[]

  @@index([organizationId])
  @@index([grantId])
}

model CommitmentConflict {
  id                   String           @id @default(cuid())
  commitmentId         String
  relatedCommitmentIds String[]         // Other commitments involved in the conflict
  conflictType         ConflictType
  description          String           @db.Text
  detectedValues       Json             // { original: any, conflicting: any, context: any }
  severity             ConflictSeverity
  status               ConflictStatus   @default(UNRESOLVED)
  resolutionAction     String?          // UPDATE_DRAFT | FLAG_FOR_REVIEW | IGNORE
  resolutionReason     String?          @db.Text
  affectedGrants       String[]
  suggestedResolution  String?          @db.Text
  resolvedBy           String?          // Clerk user ID
  resolvedAt           DateTime?
  resolutionNotes      String?          @db.Text
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  // Relations
  commitment           Commitment       @relation(fields: [commitmentId], references: [id], onDelete: Cascade)
  auditLogs            ComplianceAudit[]

  @@index([commitmentId])
  @@index([status])
}

model ComplianceAudit {
  id                   String                @id @default(cuid())
  organizationId       String
  actionType           ComplianceActionType
  description          String                @db.Text
  performedBy          String                // Clerk user ID
  metadata             Json?                 // Additional context (affected grants, commitments, etc.)
  conflictId           String?
  createdAt            DateTime              @default(now())

  // Relations
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conflict             CommitmentConflict?   @relation(fields: [conflictId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([actionType])
  @@index([createdAt])
}

model FunderRequirement {
  id             String                @id @default(cuid())
  funderId       String
  organizationId String
  type           FunderRequirementType
  description    String
  value          String?
  sourceDocument String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  // Relations
  funder         Funder                @relation(fields: [funderId], references: [id], onDelete: Cascade)
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([funderId])
  @@index([organizationId])
}

model NotificationPreferences {
  id                        String          @id @default(cuid())
  userId                    String          @unique
  email                     String          // User's email address from Clerk

  // Notification toggles
  deadlineRemindersEnabled  Boolean         @default(true)
  weeklyDigestEnabled       Boolean         @default(true)
  complianceAlertsEnabled   Boolean         @default(true)
  documentProcessedEnabled  Boolean         @default(false)

  // Deadline reminder thresholds (days before deadline)
  reminderThresholds        Int[]           @default([7, 3, 1])

  // Digest frequency
  digestFrequency           DigestFrequency @default(WEEKLY)

  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  // Relations
  user                      OrganizationUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
}

model NotificationLog {
  id                String           @id @default(cuid())
  userId            String
  type              NotificationType
  subject           String
  sentAt            DateTime         @default(now())
  metadata          Json?            // Additional context (grantId, conflictId, etc.)
  success           Boolean          @default(true)
  errorMessage      String?

  // Relations
  user              OrganizationUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([sentAt])
}

model TeamInvitation {
  id             String       @id @default(cuid())
  organizationId String
  email          String
  role           UserRole
  token          String       @unique // JWT token for invitation link
  invitedBy      String       // Clerk user ID
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([organizationId])
}

// ============================================================================
// API KEYS & WEBHOOKS (Phase 4: Public API & Integration)
// ============================================================================

model ApiKey {
  id             String    @id @default(cuid())
  organizationId String
  name           String    // Human-readable name (e.g., "Zapier Integration")
  keyPrefix      String    @unique  // First 16 chars, visible (e.g., "gs_live_abc12345")
  keyHash        String    // bcrypt hash of full key
  scopes         String[]  // ["grants:read", "grants:write", "documents:read", etc.]
  isExtension    Boolean   @default(false)  // Special flag for browser extension keys

  // Metadata
  lastUsedAt     DateTime?
  lastUsedIp     String?
  requestCount   Int       @default(0)

  // Lifecycle
  expiresAt      DateTime?
  revokedAt      DateTime?
  revokedBy      String?   // Clerk user ID
  revokedReason  String?

  createdAt      DateTime  @default(now())
  createdBy      String    // Clerk user ID
  updatedAt      DateTime  @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rateLimits     ApiKeyRateLimit?

  @@index([organizationId])
  @@index([keyPrefix])
  @@index([expiresAt])
}

model ApiKeyRateLimit {
  id                String   @id @default(cuid())
  apiKeyId          String   @unique
  requestsPerMinute Int      @default(100)
  requestsPerHour   Int      @default(1000)
  requestsPerDay    Int      @default(10000)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  apiKey            ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
}

model Webhook {
  id                 String    @id @default(cuid())
  organizationId     String
  name               String
  url                String    // Webhook endpoint URL
  signingSecret      String    // For HMAC signature verification

  // Event subscriptions
  subscribedEvents   String[]  // ["grant.status_changed", "document.processing_completed", etc.]

  // Status
  isActive           Boolean   @default(true)
  isPaused           Boolean   @default(false)
  failureCount       Int       @default(0)
  lastFailureAt      DateTime?
  lastFailureReason  String?   @db.Text

  // Metadata
  createdAt          DateTime  @default(now())
  createdBy          String    // Clerk user ID
  updatedAt          DateTime  @updatedAt

  // Relations
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries         WebhookDelivery[]

  @@index([organizationId])
  @@index([isActive])
}

model WebhookDelivery {
  id                String    @id @default(cuid())
  webhookId         String
  eventType         String    // Event name (e.g., "grant.status_changed")
  payload           Json      // The event payload sent

  // Delivery status
  status            String    // "pending", "success", "failed", "retrying"
  attempts          Int       @default(0)
  maxAttempts       Int       @default(5)

  // Response tracking
  httpStatus        Int?
  responseBody      String?   @db.Text
  errorMessage      String?   @db.Text

  // Timing
  scheduledFor      DateTime  @default(now())
  lastAttemptAt     DateTime?
  nextAttemptAt     DateTime?
  completedAt       DateTime?

  createdAt         DateTime  @default(now())

  // Relations
  webhook           Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([eventType])
  @@index([scheduledFor])
}
